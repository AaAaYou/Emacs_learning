#+TITLE: AMBAæ€»çº¿
#+AUTHOR: Wayne Lee
#+DATE: 2021-03-09

* AMBAæ€»çº¿

** DONE AHB
   <2021-04-26 ÖÜÒ» 11:07>
** TODO AXI

* AMBAæ€»çº¿ä¿¡å·åŒºåˆ†

[[../fig/Bus/AMBA/Key AMBA Specifications.png]]

** AXI
AXIæ€»çº¿ä¸­æœ‰AXI3ï¼ŒAXI4ï¼ŒAXI4 Lite

** AHB

AHBæ€»çº¿ä¸­æœ‰AHB2ï¼ŒAHB3ï¼ŒAHB Lite, AHB5

*** AHB2

**** Feature
     + burst transfer
     + split transactions
     + single cycle bus master handover
     + single clock edge operation
     + non-tristate implementation
     + wider data bus configurations(64/128 bits)
**** Signal
 | Signal        | Descriptions                                                                                                |
 |---------------+-------------------------------------------------------------------------------------------------------------|
 | HCLK          |                                                                                                             |
 | HRESETn       | Must ensure the address and control signals are at valid levels and HTRANS[1:0] indicates IDLE              |
 | HADDR[31:0]   | One cycle                                                                                                   |
 | HWDATA[31:0]  | Hold the data stable through extended cycles. data bus maximum width is 256 bts.                            |
 | HREADY        |                                                                                                             |
 | HRDATA[31:0]  | Does not have to proveide data until the transfer complete                                                  |
 | HTRANS[1:0]   | (IDLE/BUSY/NONSEQ/SEQ)                                                                                      |
 | HBURST[2:0]   | (SINGLE/INCR{*,4,8,16}/WRAP(4,8,16))                                                                        |
 | HSIZE[2:0]    | Number of beats in the burst                                                                                |
 | HWRITE        | HIGH means write transfer, LOW means read transfer                                                          |
 | HPROT[3:0]    | Provide additional info about privileged mode or user access or etc. [ *Not recommended* ]                    |
 | HSELx         | Select signal for each slave. When not select could provide a response                                      |
 | HRESP[1:0]    | HREADY is used to extend trasfer, HRESP could provide the status of the transfer. [OKAY,ERRROR,RETRY,SPLIT] |
 | HBUSREQx      | Used by bus master for request access to bus, internal priority algorithm to decide.                        |
 | HLOCKx        | Asserted by a master. Means could not change grant signals                                                  |
 | HGRANTx       | A master gains ownership of the address bus when HGRANTx is HIGH                                            |
 | HMASTER[3:0]  | Indicate which master is currently granted the bus and required by SPLIT-capable                            |
 | HMASTLOCK     | Indicate the current transfer is part of a locked sequence by asserting                                     |
 | HSPLITx[15:0] | Used by a SPLIT-capable slave to indicate bus master can complete a SPLIT transaction                       |


Early burst termination: æ­£å¸¸æƒ…å†µä¸‹ä¸Šä¸€ä¸ªçš„bursträ¼ è¾“å®Œæˆä¹‹åæ‰ä¼šå°†ä»²è£æƒäº¤ç»™æ–°çš„masterï¼Œä½†æ˜¯å­˜åœ¨ä¸€ç§é¢å¤–æƒ…å†µå°±æ˜¯ä¸ºäº†é˜²æ­¢è¿‡é•¿çš„access timeï¼Œéœ€è¦åœ¨å‰ä¸€ä¸ªburstæ²¡æœ‰å®Œæˆä¹‹å‰å°±è½¬äº¤ä»²è£æƒã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼š
 + åœ¨burstä¸­é€”ä¸¢å¤±ä»²è£æƒä¹‹åé¦–å…ˆéœ€è¦ä¿è¯HBURSTå’ŒHTRANSä¿¡å·è¢«è°ƒæ•´ä¸ºä¸å†æ¥å—æ‰§è¡Œå®Œæ•´çš„4,8,16æ‹çš„burst
 + æ¯”å¦‚å½“å†æ¬¡è·å¾—ä»²è£æƒä¹‹åï¼Œmasterå¯¹äº5æ‹ä¿¡å·è¿›è¡Œä¼ è¾“çš„æ—¶å€™å¯ä»¥ä½¿ç”¨å•ç‹¬çš„5-beatæˆ–è€…4-beat+1-beatçš„å½¢å¼å®Œæˆä¼ è¾“

å¤šä¸ªmasterå‘é€SPLITå’ŒRETRYå¯èƒ½ä¼šé€ æˆdeadlock.
For slaves that can issue a SPLIT transfer response, bus deadlock is prevented by ensuring that the slave can withstand a request from every master in the system, up to a maximum of 16.
A slave which issues RETRY responses must only be accessed by one master at a time.

[[../fig/Bus/AMBA/Handover after split transfer.png]]

**** Interconnect

[[../fig/Bus/AMBA/Multiplexor interconnection.png]]

[[../fig/Bus/AMBA/AHB bus slave interface.png]]

[[../fig/Bus/AMBA/AHB bus master interface diagram.png]]

[[../fig/Bus/AMBA/AHB arbriter interface diagram.png]]


*** AHB3 Lite

**** Feature

+ Cancel the arbiter and simplify the priority management and lock transfer.
+ Cancel the split and retry response.

**** Signal

| Signal       | Descripttion                                                                                |
|--------------+---------------------------------------------------------------------------------------------|
| HCLK         |                                                                                             |
| HRESETn      |                                                                                             |
| HADDR[31:0]  | 32-bit system addrress bus                                                                  |
| HBURST[2:0]  | Same as AHB 2.0                                                                             |
| HMASTLOCK    | Master required locked access                                                               |
| HPROT[3:0]   |                                                                                             |
| HSIZE[2:0]   |                                                                                             |
| HTRANS[1:0]  |                                                                                             |
| HWDATA[31:0] |                                                                                             |
| HWRITE       |                                                                                             |
| HRDATA[31:0] |                                                                                             |
| *HREADYOUT*    | Destination: Multiplexor. When HIGH, indicates that a transfer has finished on the bus      |
| *HRESP*        | LOW means transfer status is OKAY, HIGH means transfer status is ERROR                      |
| HSELx        |                                                                                             |
| *HREADY*       | When HIGH, indicates that the master and all slaves, that the previous transfer is complete |

Early burst can be terminated by either:
+ Slave error response
+ Multi-layer interconnect termination

**** Comparison with AHB 2.0

1. Locked transfer
*AHB3 Lite:* HMASTLOCK to slave. If the master requires locked accesses then it must also assert the HMASTLOCK signal. Multi-Port Memory Controller must implement the HMASTLOCK signal. Liteæ‹¿æ‰äº†arbiter,ç®€åŒ–äº†å¾ˆå¤šä¿¡å·. ä½¿ç”¨äº†ready & readyout
*AHB 2.0 :* HLOCKx from Master and HMASTLOCK from Arbiter. Two stage master --> /HLOCKx/ --> arbiter --> /HMASTLOCK/ --> slave. HLOCKx will keep master granted bus, HMASTLOCK will indicates to any slave that current transfer is locked. åŠ äº†ä¸€ä¸ªarbiterç”¨æ¥ä»²è£multi masterå’Œmulti slave.

2. Readyout
The AHB-Lite protocol is used with a central read data multiplexor interconnection scheme. The master drives out the address and control signals to all the slaves, with the decoder selecting the appropriate slave. Any response data from the selected slave, passes through the read data multiplexor to the master.

[[../fig/Bus/AMBA/Multiplexor interconnection in Lite.png]]

3. Slave response
Error response need two-cycle because of the pipeline of AHB.

*AHB3 Lite:* no split and retry
*AHB2.0:* The SPLIT transfer requires extra complexity in both the slave and the arbiter, but has the advantage that it completely frees the bus for use by other masters, whereas the RETRY case will only allow higher priority masters onto the bus.

4. Priority
*AHB3 Lite:* Delete the arbiter, not support grant. Each slave port has its own arbitration and a number of different schemes can be used. (Round-robin, Fixed-priority). åœ¨VSI_BUSä¸­ä½¿ç”¨äº†hqosè°ƒæ•´priority
*AHB2.0:* HGRANTx, HMASTER

**** Interconnect

å¦‚æœåªæœ‰ä¸€ä¸ªslaveæ—¶å€™ï¼Œslaveçš„è¾“å‡ºhreadyoutå’Œè¾“å…¥hreadyå¯ä»¥ç›¸äº’è¿æ¥ã€‚

#+BEGIN_COMMENT
æ ¹æ®managerä¹‹å‰è¯´çš„ï¼Œä¹Ÿéœ€è¦æ³¨æ„ä¸€ç‚¹å°±æ˜¯å†…éƒ¨æ˜¯åŒæ­¥æˆ–è€…å¼‚æ­¥çš„æ—¶å€™ï¼Œè¿æ¥å…³ç³»ä¸å¤ªä¸€æ ·
#+END_COMMENT

[[../fig/Bus/AMBA/AHB-Lite block diagram.png]]

[[../fig/Bus/AMBA/Example multi-layer AHB-Lite block diagram.png]]


*** AHB5

**** Feature

+ Extended_Memory_Types.
+ Secure_Transfers.
+ Endian.
+ Stable_Between_Clock.
+ Exclusive_Transfers.
+ Multi_Copy_Atomicity.
+ Single-copy atomicity size.
+ User signaling.

**** Signal



| Signal       | Descripttion                                                                                |
|--------------+---------------------------------------------------------------------------------------------|
| HCLK         |                                                                                             |
| HRESETn      |                                                                                             |
| HADDR[31:0]  |                                                                                             |
| HBURST[2:0]  |                                                                                             |
| HMASTLOCK    |                                                                                             |
| HPROT[3:0]   |                                                                                             |
| HPROT[6:4]   | The 3-bit extension of the HPROT signal that adds extended memory types.                    |
| HSIZE[2:0]   |                                                                                             |
| HTRANS[1:0]  |                                                                                             |
| *HNONSEC*      | Indicates that the current transfer is either a Non-secure transfer or a Secure transfer    |
| *HEXCL*        | Exclusive transfer. Indicates that the transfer is part of an Exclusive access sequence.    |
| *HMASTER[3:0]* | Generated by a master if it has multiple Exclusive capable threads.                         |
| HWDATA[31:0] |                                                                                             |
| HWRITE       |                                                                                             |
| HRDATA[31:0] |                                                                                             |
| HREADYOUT    | Destination: Multiplexor. When HIGH, indicates that a transfer has finished on the bus      |
| HRESP        | LOW means transfer status is OKAY, HIGH means transfer status is ERROR                      |
| HEXOKAY      | Exclusive Okay.Indicates the success or failure of an Exclusive Transfer.                   |
| HSELx        |                                                                                             |
| HREADY       | When HIGH, indicates that the master and all slaves, that the previous transfer is complete |

**** Comparision with AHB 3.0

1. Memory types
AHB5 defines the Extended_Memory_Types property. HPROT[6:2] could signaling and the memory type.
AHB3:
[[../fig/Bus/AMBA/3.0_Protection signal encoding.png]]
AHB5:
[[../fig/Bus/AMBA/5.0_Meaning of the HPROT bits.png]]
  The mapping that this specification recommends to provide HPROT[6:0] signaling for a component that only includes HPROT[3:0] signaling.
[[../fig/Bus/AMBA/Mapping of an HPROT3 signaling component to provide HPROT6 signaling.png]]
  åè¿‡æ¥ç›´æ¥èˆå¼ƒHPROT[6:4]å³å¯.

2. Secure transfer
AHB5 defines the Secure_Transfers property. Care must be taken when interfacing between components that do not support Secure transfers.

3. Endianness
AHB supports both big-endian and little-endian systems. AHB5 introduces the Endian property to define which form of big-endian data access is supported. Byte-invariant big-endian. Word-invariant big-endian. Little-endian.
Figure 6-1 shows an example of a data structure that requires byte-invariant access. In this example, the header fields use little-endian ordering, and the data payload uses big-endian ordering.
[[../fig/Bus/AMBA/Example mixed-endian data structure.png]]
In this structure, for example, Count is a two-byte little-endian element, meaning its lowest address is its LS byte.
y The use of byte invariance ensures that a big-endian access to the payload does not corrupt the little-endian element.

4. Exclusive Transfers
AHB5 defines the Exclusive_Transfers property. Between the Exclusive Read and the Exclusive Write there can be other Non-exclusive transfers.
+ HEXCL
+ HEXOKAY
+ HMASTER

5. Atomicity
AHB5 defines the Multi_Copy_Atomicity property. The single-copy atomicity size defines the number of data bytes that a transfer is guaranteed to update atomically.

6. User signaling
The AHB protocol does not define the function of these signals and this can lead to interoperability issues if two components use the same User signals an incompatible way.
The user signal names defined for each channel are:
+ HAUSER Address channel User signals
+ HWUSER Write data channel User signals
+ HRUSER Read data channel User signals
Where a single transfer is converted to multiple transfers and Where multiple transfers are converted to a single transfer.

**** Interconnect

Basic transaction same as AHB 3.0
